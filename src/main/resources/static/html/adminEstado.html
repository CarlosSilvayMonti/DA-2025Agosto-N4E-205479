<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cambiar estado de propietario</title>
  <link rel="stylesheet" href="./css/adminEstado.css">
  <!-- vistaWeb primero, como en el resto del proyecto -->
  <script src="/js/vistaWeb.js"></script>
</head>

<body class="page-admin-estado">
  <!-- utilesVista al inicio del body -->
  <script src="/js/utilesVista.js"></script>

  <div class="panel-estado">
    <h2>Cambiar estado de propietario</h2>

    <div id="mensaje" class="mensaje"></div>

    <!-- =========================
         FORMULARIO BUSCAR PROPIETARIO
         ========================== -->
    <form id="formBuscarPropietario" class="form-buscar-propietario" autocomplete="off">
      <div>
        <label for="cedula">Cédula del propietario:</label><br>
        <input type="text" id="cedula" name="cedula" placeholder="Ingrese cédula" required>
      </div>
      <div>
        <button type="submit">Buscar</button>
      </div>
    </form>

    <!-- =========================
         DATOS DEL PROPIETARIO
         ========================== -->
    <section class="seccion-datos-prop" id="seccionDatosPropietario" style="display:none;">
      <h3>Datos del propietario</h3>
      <p><strong>Nombre completo:</strong> <span id="nombreProp"></span></p>
      <p><strong>Estado actual:</strong> <span id="estadoActual"></span></p>
      <p><strong>Saldo actual:</strong> $<span id="saldoActual"></span></p>
    </section>

    <!-- =========================
         CAMBIO DE ESTADO
         ========================== -->
    <section class="seccion-estado" id="seccionCambiarEstado" style="display:none;">
      <h3>Cambiar estado</h3>

      <label for="selectEstado">Nuevo estado:</label>
      <div id="contenedorEstados">
        <!-- Acá se va a inyectar el <select> con los estados -->
      </div>

      <button type="button" onclick="cambiarEstado()">Cambiar estado</button>
    </section>

    <!-- =========================
         NOTIFICACIONES DEL PROPIETARIO
         ========================== -->
    <section id="seccionNotificaciones" style="display:none;">
      <h3>Notificaciones del propietario</h3>
      <div id="contenedorNotificaciones"></div>
    </section>
  </div>

  <script>
    // ================================
    // CONFIGURACIÓN INICIAL
    // ================================
    // Cuando se carga esta vista dentro del iframe del admin:
    // El controlador /adminEstado/vistaConectada debería enviar los estados posibles
    //   new Respuesta("estados", [...])
    urlIniciarVista = "/adminEstado/vistaConectada";

    const formBuscarProp = document.getElementById("formBuscarPropietario");
    const inputCedula    = document.getElementById("cedula");
    const divMensaje     = document.getElementById("mensaje");

    const seccionDatos   = document.getElementById("seccionDatosPropietario");
    const seccionEstado  = document.getElementById("seccionCambiarEstado");
    const seccionNotifs  = document.getElementById("seccionNotificaciones");

    const spanNombreProp = document.getElementById("nombreProp");
    const spanEstadoAct  = document.getElementById("estadoActual");
    const spanSaldoAct   = document.getElementById("saldoActual");
    const divEstados     = document.getElementById("contenedorEstados");
    const divNotifs      = document.getElementById("contenedorNotificaciones");

    // Guardamos la cédula del propietario actualmente encontrado
    let cedulaPropietarioActual = null;

    // ================================
    // EVENTOS
    // ================================
    formBuscarProp.addEventListener("submit", function (e) {
      e.preventDefault();
      // Buscamos propietario por cédula
      submit("/adminEstado/buscarPropietario", serializarFormulario("formBuscarPropietario"));
    });

    function cambiarEstado() {
      if (!cedulaPropietarioActual) {
        mostrar_mensaje("Primero debe buscar un propietario.");
        return;
      }

      const select = document.getElementById("selectEstado");
      if (!select || !select.value) {
        mostrar_mensaje("Debe seleccionar un estado.");
        return;
      }

      const params = "cedula=" + encodeURIComponent(cedulaPropietarioActual) +
                     "&nuevoEstado=" + encodeURIComponent(select.value);

      submit("/adminEstado/cambiarEstado", params);
    }

    // ================================
    // FUNCIONES mostrar_... INVOCADAS POR vistaWeb.js
    // ================================

    // Respuesta: new Respuesta("estados", listaEstados)
    // listaEstados puede ser ["HABILITADO","SUSPENDIDO",...] o [{nombre:"HABILITADO"},...]
    function mostrar_estados(listaEstados) {
      if (!Array.isArray(listaEstados) || listaEstados.length === 0) {
        divEstados.innerHTML = "<p>No hay estados configurados.</p>";
        return;
      }

      // Normalizamos: si viene lista de strings, arma objetos {nombre: string}
      const estadosNormalizados = listaEstados.map(e => {
        if (typeof e === "string") {
          return { nombre: e };
        }
        return e; // ya sería un objeto con .nombre
      });

      // Creamos el <select> usando nuestras utilidades
      divEstados.innerHTML = crearListaDesdeJson({
        data: estadosNormalizados,
        campoMostrar: "nombre",
        campoValor: "nombre",
        multiple: false,
        mostrarOpcionInicial: true,
        id: "selectEstado"
      });

      seccionEstado.style.display = "block";
    }

    // Respuesta: new Respuesta("propietario", propietarioDto)
    // donde propietarioDto tiene: cedula, nombreCompleto, estado, saldoActual...
    function mostrar_propietario(dto) {
      if (!dto) return;

      cedulaPropietarioActual = dto.cedula;

      spanNombreProp.textContent = dto.nombreCompleto;
      spanEstadoAct.textContent  = dto.estado;
      spanSaldoAct.textContent   = dto.saldoActual != null ? dto.saldoActual.toFixed(2) : "0.00";

      seccionDatos.style.display  = "block";
      seccionEstado.style.display = "block"; // por si aún no estaba visible
    }

    // Respuesta: new Respuesta("notificaciones", listaNotificaciones)
    // Cada notificación debería tener al menos: fechaHora, mensaje
    function mostrar_notificaciones(lista) {
      if (!Array.isArray(lista) || lista.length === 0) {
        divNotifs.innerHTML = "<p>No hay notificaciones para mostrar.</p>";
        seccionNotifs.style.display = "block";
        return;
      }

      const htmlTabla = crearTablaDesdeJson(lista);
      divNotifs.innerHTML = htmlTabla;
      seccionNotifs.style.display = "block";
    }

    // Respuesta: new Respuesta("mensaje", "texto...")
    async function mostrar_mensaje(texto) {
      divMensaje.textContent = texto || "";
      // También mostramos popup lindo
      await mostrarMensaje(texto);
    }

    // Respuesta: new Respuesta("usuarioNoAutenticado", "/html/login.html")
    function mostrar_usuarioNoAutenticado(urlDestino) {
      window.location.href = urlDestino;
    }

    // En caso de usar excepcionDeAplicacion desde vistaWeb
    async function excepcionDeAplicacion(texto) {
      await mostrar_mensaje(texto);
    }

  </script>
</body>
</html>
